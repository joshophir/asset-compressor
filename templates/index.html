<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OnePress</title>
  <script src="https://unpkg.com/@dotlottie/player-component@2.7.12/dist/dotlottie-player.mjs" type="module"></script>
  <style>
    :root {
      --bg: #0f1117;
      --surface: #1a1d27;
      --surface-2: #242836;
      --border: #2e3345;
      --text: #e4e6ef;
      --text-muted: #8b8fa3;
      --accent: #6c5ce7;
      --accent-hover: #7c6ef7;
      --success: #00b894;
      --warning: #fdcb6e;
      --danger: #e17055;
      --radius: 12px;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg); color: var(--text);
      min-height: 100vh; line-height: 1.6;
    }
    .container { max-width: 800px; margin: 0 auto; padding: 40px 24px; }
    header { text-align: center; margin-bottom: 40px; }
    header h1 { font-size: 28px; font-weight: 700; margin-bottom: 8px; letter-spacing: -0.5px; }
    header p { color: var(--text-muted); font-size: 15px; }

    /* Drop zone */
    .drop-zone {
      border: 2px dashed var(--border); border-radius: var(--radius);
      padding: 48px 32px; text-align: center; cursor: pointer;
      transition: all 0.2s; background: var(--surface);
    }
    .drop-zone:hover, .drop-zone.dragover { border-color: var(--accent); background: rgba(108,92,231,0.05); }
    .drop-zone svg { width: 48px; height: 48px; color: var(--text-muted); margin-bottom: 16px; }
    .drop-zone h3 { font-size: 18px; font-weight: 600; margin-bottom: 8px; }
    .drop-zone p { color: var(--text-muted); font-size: 14px; }
    .drop-zone .browse-link { color: var(--accent); text-decoration: underline; cursor: pointer; }
    .formats { display: inline-flex; gap: 6px; margin-top: 12px; flex-wrap: wrap; justify-content: center; }
    .formats span { background: var(--surface-2); padding: 2px 10px; border-radius: 20px; font-size: 12px; color: var(--text-muted); font-weight: 500; }
    #file-input { display: none; }

    /* File info */
    .file-info {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px 24px; margin-top: 24px; display: none;
    }
    .file-info.visible { display: block; }
    .file-info-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
    .file-info-header h3 { font-size: 16px; font-weight: 600; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; max-width: 70%; }
    .file-type-badge {
      display: inline-block; padding: 2px 10px; border-radius: 20px;
      font-size: 11px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;
    }
    .file-type-badge.video { background: rgba(108,92,231,0.15); color: var(--accent); }
    .file-type-badge.image { background: rgba(0,184,148,0.15); color: var(--success); }
    .file-type-badge.lottie { background: rgba(253,203,110,0.15); color: var(--warning); }
    .remove-btn {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 13px; padding: 4px 8px; border-radius: 6px; transition: all 0.15s;
    }
    .remove-btn:hover { color: var(--danger); background: rgba(225,112,85,0.1); }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 12px; }
    .stat { background: var(--surface-2); border-radius: 8px; padding: 12px; }
    .stat-label { font-size: 11px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 4px; }
    .stat-value { font-size: 18px; font-weight: 700; }

    /* Alpha notice */
    .alpha-notice {
      margin-top: 12px; padding: 10px 14px; border-radius: 8px;
      font-size: 13px; line-height: 1.5; display: none;
    }
    .alpha-notice.safe {
      background: rgba(0,184,148,0.08); border: 1px solid rgba(0,184,148,0.2); color: var(--success);
    }
    .alpha-notice.warn {
      background: rgba(253,203,110,0.08); border: 1px solid rgba(253,203,110,0.2); color: var(--warning);
    }
    .alpha-notice.visible { display: block; }

    /* Options */
    .options-section { margin-top: 24px; display: none; }
    .options-section.visible { display: block; }
    .options-section h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .presets { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
    .preset-card {
      background: var(--surface); border: 2px solid var(--border); border-radius: var(--radius);
      padding: 16px; cursor: pointer; transition: all 0.2s; text-align: center;
    }
    .preset-card:hover { border-color: var(--accent); }
    .preset-card.selected { border-color: var(--accent); background: rgba(108,92,231,0.08); }
    .preset-card h4 { font-size: 15px; font-weight: 600; margin-bottom: 6px; }
    .preset-card p { font-size: 12px; color: var(--text-muted); line-height: 1.5; }
    .preset-card .badge { display: inline-block; margin-top: 8px; padding: 2px 8px; border-radius: 20px; font-size: 11px; font-weight: 600; }
    .badge.green { background: rgba(0,184,148,0.15); color: var(--success); }
    .badge.yellow { background: rgba(253,203,110,0.15); color: var(--warning); }
    .badge.orange { background: rgba(225,112,85,0.15); color: var(--danger); }

    /* Advanced */
    .advanced-toggle {
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: 13px; padding: 4px 0; margin-bottom: 16px;
      display: flex; align-items: center; gap: 6px; transition: color 0.15s;
    }
    .advanced-toggle:hover { color: var(--text); }
    .advanced-toggle svg { width: 14px; height: 14px; transition: transform 0.2s; }
    .advanced-toggle.open svg { transform: rotate(90deg); }
    .advanced-options {
      display: none; background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 20px;
    }
    .advanced-options.visible { display: block; }
    .option-row { display: flex; align-items: center; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .option-row:last-child { margin-bottom: 0; }
    .option-row label { font-size: 14px; font-weight: 500; min-width: 120px; }
    .option-row .hint { font-size: 12px; color: var(--text-muted); margin-left: auto; }
    input[type="range"] { flex: 1; accent-color: var(--accent); height: 6px; min-width: 120px; }
    .range-value { font-size: 14px; font-weight: 600; min-width: 36px; text-align: right; }
    .checkbox-row { display: flex; align-items: center; gap: 10px; }
    .checkbox-row input[type="checkbox"] { accent-color: var(--accent); width: 16px; height: 16px; }
    select {
      background: var(--surface-2); color: var(--text); border: 1px solid var(--border);
      border-radius: 6px; padding: 6px 12px; font-size: 14px; cursor: pointer;
    }

    /* Buttons */
    .compress-btn {
      width: 100%; padding: 14px 32px; border: none; border-radius: var(--radius);
      background: var(--accent); color: white; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .compress-btn:hover { background: var(--accent-hover); }
    .compress-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .compress-btn .spinner {
      width: 18px; height: 18px;
      border: 2px solid rgba(255,255,255,0.3); border-top-color: white;
      border-radius: 50%; animation: spin 0.8s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Results */
    .results { margin-top: 24px; display: none; }
    .results.visible { display: block; }
    .results h3 { font-size: 16px; font-weight: 600; margin-bottom: 16px; }
    .comparison { display: grid; grid-template-columns: 1fr auto 1fr; gap: 16px; align-items: center; margin-bottom: 20px; }
    .comparison-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 20px; text-align: center; }
    .comparison-card .label { font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-muted); margin-bottom: 8px; }
    .comparison-card .size { font-size: 28px; font-weight: 800; }
    .comparison-card .size.new { color: var(--success); }
    .arrow { font-size: 24px; color: var(--text-muted); }
    .reduction-badge {
      display: inline-block; background: rgba(0,184,148,0.15); color: var(--success);
      padding: 6px 16px; border-radius: 20px; font-size: 14px; font-weight: 700; margin-bottom: 20px;
    }

    /* Preview */
    .preview-area { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 20px; }
    .preview-box { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); overflow: hidden; }
    .preview-box .preview-label {
      padding: 10px 16px; font-size: 12px; text-transform: uppercase;
      letter-spacing: 0.5px; color: var(--text-muted); border-bottom: 1px solid var(--border); font-weight: 600;
    }
    .preview-box video, .preview-box img { width: 100%; display: block; background: #000; }
    .preview-box dotlottie-player { width: 100%; display: block; background: #000; }

    .download-btn {
      width: 100%; padding: 14px 32px; border: none; border-radius: var(--radius);
      background: var(--success); color: white; font-size: 16px; font-weight: 600;
      cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
    }
    .download-btn:hover { opacity: 0.9; }
    .frame0-btn {
      width: 100%; padding: 12px 32px; border: 1px solid var(--border);
      border-radius: var(--radius); background: var(--surface); color: var(--text);
      font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      margin-top: 10px;
    }
    .frame0-btn:hover { border-color: var(--accent); background: rgba(108,92,231,0.06); }
    .frame0-btn .frame0-size { font-weight: 400; color: var(--text-muted); font-size: 13px; }
    .start-over-btn {
      width: 100%; padding: 12px 32px; border: 1px solid var(--border);
      border-radius: var(--radius); background: transparent; color: var(--text-muted);
      font-size: 14px; cursor: pointer; transition: all 0.15s; margin-top: 12px;
    }
    .start-over-btn:hover { border-color: var(--text-muted); color: var(--text); }

    /* Retry section */
    .retry-section {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 20px; margin-bottom: 20px; text-align: center;
    }
    .retry-section p {
      font-size: 14px; color: var(--text-muted); margin-bottom: 14px;
    }
    .retry-section p strong { color: var(--text); }
    .retry-buttons { display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; }
    .retry-btn {
      padding: 10px 20px; border-radius: 8px; font-size: 13px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; border: 1px solid var(--border); background: var(--surface-2); color: var(--text);
    }
    .retry-btn:hover { border-color: var(--accent); background: rgba(108,92,231,0.08); }
    .retry-btn.active {
      border-color: var(--accent); background: rgba(108,92,231,0.12); color: var(--accent);
      cursor: default;
    }
    .retry-btn .retry-label { display: block; margin-bottom: 2px; }
    .retry-btn .retry-hint { display: block; font-size: 11px; font-weight: 400; color: var(--text-muted); }

    /* Preview mode selector */
    .preview-mode-selector {
      display: flex; gap: 6px; margin-bottom: 8px; padding: 4px;
      background: var(--surface); border-radius: 10px; border: 1px solid var(--border);
    }
    .preview-mode-btn {
      flex: 1; padding: 8px 12px; border: none; border-radius: 7px;
      background: transparent; color: var(--text-muted); font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.15s; white-space: nowrap;
    }
    .preview-mode-btn:hover { color: var(--text); background: var(--surface-2); }
    .preview-mode-btn.active { background: var(--accent); color: white; }

    .preview-sub-toggle {
      display: flex; gap: 4px; justify-content: center; margin-bottom: 16px;
    }
    .sub-toggle-btn {
      padding: 5px 16px; border: 1px solid var(--border); border-radius: 20px;
      background: transparent; color: var(--text-muted); font-size: 11px; font-weight: 600;
      cursor: pointer; transition: all 0.15s;
    }
    .sub-toggle-btn:hover { border-color: var(--accent); color: var(--text); }
    .sub-toggle-btn.active { background: var(--surface-2); border-color: var(--accent); color: var(--text); }

    /* iPhone frame */
    .insitu-container { display: flex; justify-content: center; margin-bottom: 20px; }
    .phone-wrapper { width: 320px; }
    .phone-frame {
      width: 393px; height: 852px;
      background: #000; border-radius: 55px;
      border: 4px solid #3a3a3c;
      position: relative; overflow: hidden;
      transform: scale(0.814); transform-origin: top left;
    }
    .phone-notch {
      position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
      width: 126px; height: 36px; background: #000; border-radius: 20px; z-index: 50;
    }
    .phone-screen {
      width: 100%; height: 100%; overflow: hidden; position: relative;
      border-radius: 51px;
    }

    /* Shared mockup styles */
    .mu { font-family: -apple-system, 'SF Pro Display', 'SF Pro Text', sans-serif; }
    .mu-close {
      position: absolute; top: 56px; right: 16px; z-index: 20;
      width: 30px; height: 30px; border-radius: 50%;
      background: rgba(255,255,255,0.12); display: flex;
      align-items: center; justify-content: center;
      color: rgba(255,255,255,0.8); font-size: 14px; font-weight: 300;
    }
    .mu-cta-btn {
      width: 100%; height: 50px; border-radius: 14px;
      background: #22C3F0; display: flex; align-items: center;
      justify-content: center; font-size: 17px; font-weight: 700; color: #000;
    }
    .mu-home-bar {
      width: 134px; height: 5px; border-radius: 3px; background: #fff;
      margin: 8px auto 8px;
    }
    .mu-statusbar {
      height: 54px; display: flex; align-items: flex-end; justify-content: space-between;
      padding: 0 24px 8px; font-size: 15px; font-weight: 600; color: #fff;
      position: relative; z-index: 10;
    }
    .mu-status-icons { display: flex; gap: 5px; align-items: center; font-size: 12px; }

    .mu-asset-el video, .mu-asset-el img {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .mu-asset-el dotlottie-player {
      width: 100%; height: 100%; display: block;
    }

    /* Value prop row */
    .mu-prop-row {
      display: flex; align-items: flex-start; gap: 12px; padding: 4px 0;
    }
    .mu-prop-icon {
      width: 40px; height: 40px; border-radius: 10px; flex-shrink: 0;
      background: rgba(34,195,240,0.12);
      display: flex; align-items: center; justify-content: center;
      font-size: 18px; color: #22C3F0;
    }
    .mu-prop-text { display: flex; flex-direction: column; gap: 2px; }
    .mu-prop-title { font-size: 15px; font-weight: 700; color: #fff; }
    .mu-prop-sub { font-size: 13px; color: rgba(255,255,255,0.5); }

    /* --- Full Screen Interstitial mockup --- */
    .mu-fsi {
      width: 100%; height: 100%; position: relative; overflow: hidden;
    }
    .mu-fsi .mu-bg {
      position: absolute; inset: 0; z-index: 0;
    }
    .mu-fsi .mu-bg video, .mu-fsi .mu-bg img {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .mu-fsi .mu-bg dotlottie-player {
      width: 100%; height: 100%; display: block;
    }
    .mu-fsi .mu-overlay {
      position: absolute; inset: 0; z-index: 1;
      display: flex; flex-direction: column;
      background: linear-gradient(to bottom,
        rgba(0,0,0,0.15) 0%,
        transparent 30%,
        transparent 50%,
        rgba(0,0,0,0.65) 75%,
        rgba(0,0,0,0.85) 100%
      );
    }
    .mu-fsi .mu-close {
      position: absolute; top: 56px; right: 16px; z-index: 20;
    }
    .mu-fsi .mu-content {
      margin-top: auto; padding: 0 24px; text-align: center;
      display: flex; flex-direction: column; gap: 8px;
    }
    .mu-fsi .mu-h1 {
      font-size: 28px; font-weight: 800; color: #fff; line-height: 1.15;
      text-shadow: 0 2px 12px rgba(0,0,0,0.5);
    }
    .mu-fsi .mu-sub {
      font-size: 15px; color: rgba(255,255,255,0.8); line-height: 1.4;
      text-shadow: 0 1px 6px rgba(0,0,0,0.4);
    }
    .mu-fsi .mu-footer {
      padding: 16px 24px 0; flex-shrink: 0;
    }
    .mu-fsi .mu-legal {
      font-size: 10px; color: rgba(255,255,255,0.4); text-align: center;
      padding: 8px 24px 0; line-height: 1.4;
      text-shadow: 0 1px 4px rgba(0,0,0,0.4);
    }

    /* --- Full Sheet mockup --- */
    .mu-fs {
      width: 100%; height: 100%; background: #121212;
      display: flex; flex-direction: column; overflow-y: auto;
    }
    .mu-fs .mu-hero-bleed {
      width: 100%; height: 320px; flex-shrink: 0; position: relative; overflow: hidden;
      background: #1a1f28;
    }
    .mu-fs .mu-hero-inline {
      margin: 8px 16px 0; border-radius: 16px; height: 260px; flex-shrink: 0;
      position: relative; overflow: hidden; background: #1a1f28;
    }
    .mu-fs .mu-hero-gradient {
      position: absolute; bottom: 0; left: 0; right: 0; height: 100px;
      background: linear-gradient(transparent, #121212);
    }
    .mu-fs .mu-titlebar {
      height: 44px; display: flex; align-items: center; justify-content: center;
      position: relative; flex-shrink: 0;
    }
    .mu-fs .mu-titlebar-text {
      font-size: 17px; font-weight: 600; color: #fff;
    }
    .mu-fs .mu-titlebar .mu-close {
      position: absolute; top: 7px; right: 16px;
    }
    .mu-fs .mu-content {
      flex: 1; padding: 16px 24px; display: flex; flex-direction: column; gap: 12px;
      text-align: center;
    }
    .mu-fs .mu-h1 {
      font-size: 26px; font-weight: 800; color: #fff; line-height: 1.2;
    }
    .mu-fs .mu-sub {
      font-size: 15px; color: rgba(255,255,255,0.55); line-height: 1.4;
    }
    .mu-fs .mu-props {
      display: flex; flex-direction: column; gap: 8px;
      text-align: left; margin-top: 4px;
    }
    .mu-fs .mu-legal {
      font-size: 11px; color: rgba(255,255,255,0.3); line-height: 1.4;
      text-align: left; margin-top: auto; padding-top: 12px;
    }
    .mu-fs .mu-footer {
      padding: 8px 24px 0; flex-shrink: 0;
    }

    /* --- Half Sheet mockup --- */
    .mu-hs {
      width: 100%; height: 100%; position: relative; background: #121212;
    }
    .mu-hs .mu-backdrop {
      position: absolute; inset: 0; background: rgba(0,0,0,0.55);
    }
    .mu-hs .mu-sheet {
      position: absolute; bottom: 0; left: 0; right: 0;
      background: #121212; border-radius: 32px 32px 0 0;
      box-shadow: 0px -12px 40px rgba(28,28,30,0.8);
      display: flex; flex-direction: column; overflow: hidden;
    }
    .mu-hs .mu-handle {
      width: 36px; height: 5px; border-radius: 3px; background: rgba(255,255,255,0.2);
      margin: 10px auto 0; flex-shrink: 0;
    }
    .mu-hs .mu-sheet-close {
      position: absolute; top: 12px; right: 16px; z-index: 20;
      width: 30px; height: 30px; border-radius: 50%;
      background: rgba(255,255,255,0.12); display: flex;
      align-items: center; justify-content: center;
      color: rgba(255,255,255,0.8); font-size: 14px;
    }
    .mu-hs .mu-hero-bleed {
      width: 100%; height: 240px; flex-shrink: 0; overflow: hidden;
      background: #1a1f28; margin-top: 8px;
    }
    .mu-hs .mu-hero-inline {
      margin: 12px 16px 0; border-radius: 16px; height: 200px; flex-shrink: 0;
      overflow: hidden; background: #1a1f28;
    }
    .mu-hs .mu-content {
      flex: 1; padding: 16px 24px; display: flex; flex-direction: column; gap: 8px;
      text-align: center;
    }
    .mu-hs .mu-h1 {
      font-size: 22px; font-weight: 800; color: #fff; line-height: 1.2;
    }
    .mu-hs .mu-sub {
      font-size: 14px; color: rgba(255,255,255,0.55); line-height: 1.4;
    }
    .mu-hs .mu-legal {
      font-size: 10px; color: rgba(255,255,255,0.3); line-height: 1.4;
      text-align: left; margin-top: auto; padding-top: 8px;
    }
    .mu-hs .mu-footer { padding: 8px 24px 0; flex-shrink: 0; }

    /* --- Banner mockup --- */
    .mu-bn {
      width: 100%; height: 100%; background: #121212;
      display: flex; flex-direction: column;
    }
    .mu-bn .mu-screen-body {
      flex: 1; padding: 0 16px; display: flex; flex-direction: column; gap: 16px;
    }
    .mu-bn .mu-nav {
      display: flex; gap: 10px; padding: 4px 0; align-items: center;
    }
    .mu-bn .mu-nav-avi {
      width: 32px; height: 32px; border-radius: 50%; background: rgba(255,255,255,0.1);
    }
    .mu-bn .mu-balance {
      padding: 12px 0 8px;
    }
    .mu-bn .mu-balance-label {
      font-size: 12px; color: rgba(255,255,255,0.4); margin-bottom: 4px;
    }
    .mu-bn .mu-balance-amount {
      font-size: 34px; font-weight: 800; color: #fff;
    }
    .mu-bn .mu-banner-card {
      position: relative; width: 100%; height: 128px;
      background: #191E24; border: 1px solid #2C343E;
      border-radius: 16px; overflow: hidden;
    }
    .mu-bn .mu-banner-bg {
      position: absolute; inset: 0; z-index: 0;
    }
    .mu-bn .mu-banner-bg video, .mu-bn .mu-banner-bg img {
      width: 100%; height: 100%; object-fit: cover; display: block;
    }
    .mu-bn .mu-banner-bg dotlottie-player {
      width: 100%; height: 100%; display: block;
    }
    .mu-bn .mu-banner-overlay {
      position: relative; z-index: 1; padding: 16px;
      height: 100%; display: flex; flex-direction: column;
      justify-content: center; gap: 4px;
    }
    .mu-bn .mu-banner-title {
      font-size: 17px; font-weight: 800; font-style: italic; color: #fff;
      text-shadow: 0 1px 6px rgba(0,0,0,0.5);
    }
    .mu-bn .mu-banner-sub {
      font-size: 12px; color: rgba(255,255,255,0.7);
      text-shadow: 0 1px 4px rgba(0,0,0,0.5);
    }
    .mu-bn .mu-banner-link {
      font-size: 13px; font-weight: 600; color: #22C3F0; margin-top: 2px;
      text-shadow: 0 1px 4px rgba(0,0,0,0.5);
    }
    .mu-bn .mu-list-items {
      display: flex; flex-direction: column; gap: 1px; margin-top: 4px;
    }
    .mu-bn .mu-list-item {
      height: 52px; display: flex; align-items: center; gap: 12px; padding: 0 4px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
    }
    .mu-bn .mu-li-icon {
      width: 36px; height: 36px; border-radius: 50%; background: rgba(255,255,255,0.06);
    }
    .mu-bn .mu-li-text {
      flex: 1; display: flex; flex-direction: column; gap: 3px;
    }
    .mu-bn .mu-li-t1 { height: 11px; width: 60%; border-radius: 3px; background: rgba(255,255,255,0.15); }
    .mu-bn .mu-li-t2 { height: 9px; width: 40%; border-radius: 3px; background: rgba(255,255,255,0.06); }
    .mu-bn .mu-tab-bar {
      height: 80px; flex-shrink: 0; border-top: 1px solid rgba(255,255,255,0.06);
      display: flex; align-items: center; justify-content: space-around; padding: 0 16px;
    }
    .mu-bn .mu-tab {
      display: flex; flex-direction: column; align-items: center; gap: 3px;
    }
    .mu-bn .mu-tab-icon {
      width: 22px; height: 22px; border-radius: 5px; background: rgba(255,255,255,0.08);
    }
    .mu-bn .mu-tab-label {
      font-size: 9px; color: rgba(255,255,255,0.3);
    }

    .tip-box {
      background: rgba(108,92,231,0.06); border: 1px solid rgba(108,92,231,0.15);
      border-radius: var(--radius); padding: 16px 20px; margin-top: 32px;
      font-size: 13px; color: var(--text-muted); line-height: 1.6;
    }
    .tip-box strong { color: var(--text); }

    @media (max-width: 640px) {
      .presets { grid-template-columns: 1fr; }
      .comparison { grid-template-columns: 1fr; gap: 8px; }
      .arrow { transform: rotate(90deg); text-align: center; }
      .preview-area { grid-template-columns: 1fr; }
      .option-row { flex-direction: column; align-items: flex-start; gap: 8px; }
      .option-row .hint { margin-left: 0; }
      .preview-mode-selector { flex-wrap: wrap; }
      .phone-frame { transform: scale(0.7); }
      .phone-wrapper { width: 275px; }
    }
  </style>
</head>
<body>
<div class="container">
  <header>
    <h1>OnePress</h1>
    <p>Compress videos, Lotties, and images for the OnePay app &mdash; one press, ready to ship.</p>
  </header>

  <!-- Upload -->
  <div class="drop-zone" id="drop-zone">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
    </svg>
    <h3>Drop your file here</h3>
    <p>or <span class="browse-link">browse files</span></p>
    <div class="formats">
      <span>MP4</span><span>MOV</span><span>WebM</span>
      <span>Lottie</span>
      <span>PNG</span><span>JPG</span><span>WebP</span>
    </div>
    <input type="file" id="file-input" accept=".mp4,.mov,.webm,.lottie,.png,.jpg,.jpeg,.webp" />
  </div>

  <!-- File info -->
  <div class="file-info" id="file-info">
    <div class="file-info-header">
      <div style="display:flex; align-items:center; gap:10px; min-width:0;">
        <h3 id="file-name">-</h3>
        <span class="file-type-badge" id="file-type-badge">-</span>
      </div>
      <button class="remove-btn" id="remove-btn">Remove</button>
    </div>
    <div class="stats-grid" id="stats-grid"></div>
    <div class="alpha-notice" id="alpha-notice"></div>
  </div>

  <!-- Options -->
  <div class="options-section" id="options-section">
    <h3>Choose compression level</h3>
    <div class="presets" id="presets-container"></div>

    <button class="advanced-toggle" id="advanced-toggle">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
        <path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" />
      </svg>
      Advanced options
    </button>
    <div class="advanced-options" id="advanced-options"></div>

    <button class="compress-btn" id="compress-btn">Compress</button>
  </div>

  <!-- Results -->
  <div class="results" id="results">
    <h3>Compression complete</h3>
    <div style="text-align:center; margin-bottom:16px;">
      <span class="reduction-badge" id="reduction-badge">-</span>
    </div>
    <div class="comparison">
      <div class="comparison-card">
        <div class="label">Original</div>
        <div class="size" id="result-original">-</div>
      </div>
      <div class="arrow">&#8594;</div>
      <div class="comparison-card">
        <div class="label">Compressed</div>
        <div class="size new" id="result-compressed">-</div>
      </div>
    </div>
    <div class="preview-mode-selector" id="preview-mode-selector">
      <button class="preview-mode-btn active" data-mode="raw">Side by side</button>
      <button class="preview-mode-btn" data-mode="fullscreen">Full Screen</button>
      <button class="preview-mode-btn" data-mode="fullsheet">Full Sheet</button>
      <button class="preview-mode-btn" data-mode="halfsheet">Half Sheet</button>
      <button class="preview-mode-btn" data-mode="banner">Banner</button>
    </div>
    <div class="preview-sub-toggle" id="preview-sub-toggle" style="display:none;">
      <button class="sub-toggle-btn active" data-variant="bleed">Full-bleed</button>
      <button class="sub-toggle-btn" data-variant="inline">Inline</button>
    </div>

    <div class="preview-area" id="preview-area"></div>

    <div class="insitu-container" id="insitu-container" style="display:none;">
      <div class="phone-wrapper">
        <div class="phone-frame">
          <div class="phone-notch"></div>
          <div class="phone-screen" id="phone-screen"></div>
        </div>
      </div>
    </div>

    <div class="retry-section" id="retry-section">
      <p><strong>Not quite right?</strong> Try a different compression level &mdash; no need to re-upload.</p>
      <div class="retry-buttons" id="retry-buttons"></div>
    </div>

    <button class="download-btn" id="download-btn">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="20" height="20">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
      </svg>
      Download Compressed File
    </button>
    <button class="frame0-btn" id="frame0-btn" style="display:none;">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" width="18" height="18">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
      </svg>
      <span id="frame0-btn-text">Download Frame 0</span>
    </button>
    <button class="start-over-btn" id="start-over-btn">Start over with a new file</button>
  </div>

  <div class="tip-box" id="tip-box"></div>
</div>

<script>
const state = { fileId: null, assetType: null, preset: 'balanced', advancedOpen: false, fileData: null };

const $ = id => document.getElementById(id);

const PRESET_CONFIGS = {
  video: [
    { key: 'light', title: 'Light', desc: 'Minimal quality loss. For hero placements on high-traffic screens.', badge: 'Highest quality', badgeClass: 'green' },
    { key: 'balanced', title: 'Balanced', desc: 'Great size reduction with negligible visual difference.', badge: 'Recommended', badgeClass: 'yellow' },
    { key: 'aggressive', title: 'Maximum', desc: 'Smallest file size. Best for small or deep-screen placements.', badge: 'Smallest file', badgeClass: 'orange' },
  ],
  image: [
    { key: 'light', title: 'Light', desc: 'Near-lossless. Best for large hero images on high-traffic screens.', badge: 'Highest quality', badgeClass: 'green' },
    { key: 'balanced', title: 'Balanced', desc: 'Great balance of quality and size. Works for most images.', badge: 'Recommended', badgeClass: 'yellow' },
    { key: 'aggressive', title: 'Maximum', desc: 'Prioritize size. Good for thumbnails and deep screens.', badge: 'Smallest file', badgeClass: 'orange' },
  ],
  lottie: [
    { key: 'light', title: 'Light', desc: 'Recompress frames at high quality. Keeps original frame rate.', badge: 'Highest quality', badgeClass: 'green' },
    { key: 'balanced', title: 'Balanced', desc: 'Recompress + reduce to 15fps. Great for most animations.', badge: 'Recommended', badgeClass: 'yellow' },
    { key: 'aggressive', title: 'Maximum', desc: 'Heavy recompression, 12fps, and 75% scale. Smallest file.', badge: 'Smallest file', badgeClass: 'orange' },
  ],
};

const TIPS = {
  video: `<strong>Video tips:</strong><br/>
    &bull; <strong>Balanced</strong> is recommended for most animations and typically cuts file size by 70-85%.<br/>
    &bull; Use <strong>Light</strong> for hero placements on the Home screen or other high-traffic areas.<br/>
    &bull; Use <strong>Maximum</strong> for animations deeper in the app (L3+ screens, carousels).<br/>
    &bull; Animations usually don't need audio &mdash; it's stripped by default.`,
  image: `<strong>Image tips:</strong><br/>
    &bull; PNG images with no transparency are automatically converted to JPEG for big savings.<br/>
    &bull; If your image needs transparency, use WebP format in the advanced options.<br/>
    &bull; Always use the <strong>2x export</strong> from your design tool &mdash; 1x looks blurry on modern phones.`,
  lottie: `<strong>Lottie tips:</strong><br/>
    &bull; Most Lotties from Creative are image sequences (raster frames inside a zip). That's what this tool optimizes.<br/>
    &bull; <strong>Balanced</strong> recompresses frames to WebP and drops to 15fps &mdash; usually 60-80% smaller.<br/>
    &bull; If the Lottie is a true vector animation (no embedded images), it's already small and won't benefit much from recompression.<br/>
    &bull; Preview at <a href="https://iconscout.com/tools/lottie-preview" target="_blank" style="color:var(--accent)">Iconscout Lottie Preview</a> after downloading.`,
};

// ---- Upload ----
const dropZone = $('drop-zone');
const fileInput = $('file-input');

dropZone.addEventListener('click', () => fileInput.click());
dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); if (e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]); });
fileInput.addEventListener('change', () => { if (fileInput.files.length) handleFile(fileInput.files[0]); });
$('remove-btn').addEventListener('click', resetAll);
$('start-over-btn').addEventListener('click', resetAll);

function resetAll() {
  state.fileId = null; state.assetType = null; state.fileData = null;
  fileInput.value = '';
  $('file-info').classList.remove('visible');
  $('options-section').classList.remove('visible');
  $('results').classList.remove('visible');
  dropZone.style.display = '';
  state.advancedOpen = false;
  $('advanced-toggle').classList.remove('open');
  $('advanced-options').classList.remove('visible');
}

async function handleFile(file) {
  const form = new FormData();
  form.append('file', file);

  dropZone.style.display = 'none';
  $('file-info').classList.add('visible');
  $('file-name').textContent = file.name;
  $('stats-grid').innerHTML = '<div class="stat"><div class="stat-label">Analyzing</div><div class="stat-value">...</div></div>';
  $('alpha-notice').classList.remove('visible');

  try {
    const res = await fetch('/api/upload', { method: 'POST', body: form });
    const text = await res.text();
    let data;
    try { data = JSON.parse(text); } catch {
      alert('Server returned an invalid response. The file may be too large — max 50 MB.'); resetAll(); return;
    }
    if (!res.ok) { alert(data.error || 'Upload failed'); resetAll(); return; }

    state.fileId = data.file_id;
    state.assetType = data.asset_type;
    state.fileData = data;

    $('file-name').textContent = data.original_name;
    renderTypeBadge(data.asset_type);
    renderStats(data);
    renderPresets(data.asset_type);
    renderAdvanced(data.asset_type, data);
    $('tip-box').innerHTML = TIPS[data.asset_type] || '';

    $('options-section').classList.add('visible');
    $('results').classList.remove('visible');
  } catch {
    alert('Upload failed. Please try again.');
    resetAll();
  }
}

function renderTypeBadge(type) {
  const badge = $('file-type-badge');
  badge.textContent = type;
  badge.className = 'file-type-badge ' + type;
}

function renderStats(data) {
  const grid = $('stats-grid');
  const items = [{ label: 'File size', value: formatSize(data.file_size) }];

  if (data.asset_type === 'video') {
    if (data.width) items.push({ label: 'Resolution', value: `${data.width}x${data.height}` });
    if (data.duration) items.push({ label: 'Duration', value: data.duration + 's' });
    if (data.fps) items.push({ label: 'Frame rate', value: data.fps + ' fps' });
  } else if (data.asset_type === 'image') {
    items.push({ label: 'Dimensions', value: `${data.width}x${data.height}` });
    items.push({ label: 'Format', value: data.format });
    items.push({ label: 'Mode', value: data.mode });
  } else if (data.asset_type === 'lottie') {
    items.push({ label: 'Canvas', value: `${data.canvas_w}x${data.canvas_h}` });
    items.push({ label: 'Duration', value: data.duration + 's' });
    items.push({ label: 'Frames', value: `${data.image_count} @ ${data.fps}fps` });
  }

  grid.innerHTML = items.map(i => `<div class="stat"><div class="stat-label">${i.label}</div><div class="stat-value">${i.value}</div></div>`).join('');

  const notice = $('alpha-notice');
  notice.classList.remove('visible', 'safe', 'warn');
  if (data.asset_type === 'image') {
    if (data.has_alpha && !data.alpha_used) {
      notice.className = 'alpha-notice safe visible';
      notice.textContent = 'This image has an alpha channel but it\'s fully opaque. It will be converted to JPEG for much better compression.';
    } else if (data.alpha_used) {
      notice.className = 'alpha-notice warn visible';
      notice.textContent = 'This image uses transparency. It will be saved as WebP to preserve the alpha channel.';
    }
  }
  if (data.asset_type === 'lottie' && !data.is_image_sequence) {
    notice.className = 'alpha-notice warn visible';
    notice.textContent = 'This is a vector Lottie (no embedded raster images). Compression won\'t help much since it\'s already lightweight.';
  }
}

function renderPresets(type) {
  const container = $('presets-container');
  const presets = PRESET_CONFIGS[type] || PRESET_CONFIGS.video;
  state.preset = 'balanced';
  container.innerHTML = presets.map(p => `
    <div class="preset-card ${p.key === 'balanced' ? 'selected' : ''}" data-preset="${p.key}">
      <h4>${p.title}</h4>
      <p>${p.desc}</p>
      <span class="badge ${p.badgeClass}">${p.badge}</span>
    </div>
  `).join('');
  container.querySelectorAll('.preset-card').forEach(card => {
    card.addEventListener('click', () => {
      container.querySelectorAll('.preset-card').forEach(c => c.classList.remove('selected'));
      card.classList.add('selected');
      state.preset = card.dataset.preset;
      syncAdvancedToPreset(type);
    });
  });
}

function renderAdvanced(type, data) {
  const container = $('advanced-options');
  let html = '';

  if (type === 'video') {
    html = `
      <div class="option-row">
        <label>Quality (CRF)</label>
        <input type="range" id="adv-crf" min="18" max="36" value="27" />
        <span class="range-value" id="adv-crf-val">27</span>
        <span class="hint">Lower = better quality, bigger file</span>
      </div>
      <div class="option-row">
        <label>Scale</label>
        <input type="range" id="adv-scale" min="25" max="100" value="100" step="5" />
        <span class="range-value" id="adv-scale-val">100%</span>
        <span class="hint">Reduce resolution</span>
      </div>
      <div class="option-row">
        <label>Max FPS</label>
        <input type="range" id="adv-fps" min="10" max="60" value="30" step="5" />
        <span class="range-value" id="adv-fps-val">30</span>
        <span class="hint">Cap frame rate</span>
      </div>
      <div class="option-row">
        <div class="checkbox-row">
          <input type="checkbox" id="adv-strip-audio" checked />
          <label for="adv-strip-audio">Remove audio track</label>
        </div>
        <span class="hint">Animations usually don't need audio</span>
      </div>`;
  } else if (type === 'image') {
    const fmtOptions = data.alpha_used
      ? '<option value="webp" selected>WebP</option><option value="png">PNG</option>'
      : '<option value="jpg" selected>JPEG</option><option value="webp">WebP</option><option value="png">PNG</option>';
    html = `
      <div class="option-row">
        <label>Format</label>
        <select id="adv-fmt">${fmtOptions}</select>
        <span class="hint">${data.alpha_used ? 'WebP preserves transparency' : 'JPEG is best for non-transparent images'}</span>
      </div>
      <div class="option-row">
        <label>Quality</label>
        <input type="range" id="adv-quality" min="50" max="100" value="90" />
        <span class="range-value" id="adv-quality-val">90</span>
        <span class="hint">Lower = smaller file</span>
      </div>
      <div class="option-row">
        <label>Scale</label>
        <input type="range" id="adv-scale" min="25" max="100" value="100" step="5" />
        <span class="range-value" id="adv-scale-val">100%</span>
        <span class="hint">Reduce dimensions</span>
      </div>`;
  } else if (type === 'lottie') {
    html = `
      <div class="option-row">
        <label>WebP Quality</label>
        <input type="range" id="adv-quality" min="30" max="95" value="65" />
        <span class="range-value" id="adv-quality-val">65</span>
        <span class="hint">Quality of each frame</span>
      </div>
      <div class="option-row">
        <label>Target FPS</label>
        <input type="range" id="adv-fps" min="8" max="${Math.round(data.fps || 30)}" value="15" />
        <span class="range-value" id="adv-fps-val">15</span>
        <span class="hint">Lower = fewer frames = smaller</span>
      </div>
      <div class="option-row">
        <label>Scale</label>
        <input type="range" id="adv-scale" min="25" max="100" value="100" step="5" />
        <span class="range-value" id="adv-scale-val">100%</span>
        <span class="hint">Reduce frame dimensions</span>
      </div>`;
  }

  container.innerHTML = html;

  container.querySelectorAll('input[type="range"]').forEach(slider => {
    const valSpan = document.getElementById(slider.id + '-val');
    if (!valSpan) return;
    slider.addEventListener('input', () => {
      valSpan.textContent = slider.id.includes('scale') ? slider.value + '%' : slider.value;
    });
  });

  syncAdvancedToPreset(type);
}

function syncAdvancedToPreset(type) {
  const p = state.preset;
  if (type === 'video') {
    const map = { light: 23, balanced: 27, aggressive: 31 };
    setSlider('adv-crf', map[p]);
  } else if (type === 'image') {
    const map = { light: 95, balanced: 90, aggressive: 85 };
    setSlider('adv-quality', map[p]);
  } else if (type === 'lottie') {
    const qMap = { light: 80, balanced: 65, aggressive: 55 };
    const fMap = { light: state.fileData?.fps || 30, balanced: 15, aggressive: 12 };
    const sMap = { light: 100, balanced: 100, aggressive: 75 };
    setSlider('adv-quality', qMap[p]);
    setSlider('adv-fps', fMap[p]);
    setSlider('adv-scale', sMap[p]);
  }
}

function setSlider(id, val) {
  const el = document.getElementById(id);
  if (!el) return;
  el.value = val;
  const valEl = document.getElementById(id + '-val');
  if (valEl) valEl.textContent = id.includes('scale') ? val + '%' : val;
}

// Advanced toggle
$('advanced-toggle').addEventListener('click', () => {
  state.advancedOpen = !state.advancedOpen;
  $('advanced-toggle').classList.toggle('open', state.advancedOpen);
  $('advanced-options').classList.toggle('visible', state.advancedOpen);
});

// ---- Compress ----
async function runCompress(presetOverride) {
  if (!state.fileId) return;

  if (presetOverride) state.preset = presetOverride;

  const body = { file_id: state.fileId, asset_type: state.assetType, preset: state.preset };

  if (!presetOverride && state.advancedOpen) {
    const type = state.assetType;
    if (type === 'video') {
      body.crf = intVal('adv-crf');
      const s = intVal('adv-scale');
      if (s < 100) body.scale = s / 100;
      body.max_fps = intVal('adv-fps');
      body.strip_audio = document.getElementById('adv-strip-audio')?.checked ?? true;
    } else if (type === 'image') {
      body.quality = intVal('adv-quality');
      body.fmt = document.getElementById('adv-fmt')?.value || 'jpg';
      const s = intVal('adv-scale');
      if (s < 100) body.scale = s / 100;
    } else if (type === 'lottie') {
      body.quality = intVal('adv-quality');
      body.target_fps = intVal('adv-fps');
      const s = intVal('adv-scale');
      body.scale = s / 100;
    }
  }

  const res = await fetch('/api/compress', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(body) });
  const text = await res.text();
  let data;
  try { data = JSON.parse(text); } catch {
    throw new Error('The server ran out of memory or timed out compressing this file. Try the "Maximum" preset (uses less memory), or try again in a moment — the server may have been restarting.');
  }
  if (!res.ok) throw new Error(data.error || 'Compression failed');

  $('result-original').textContent = formatSize(data.original_size);
  $('result-compressed').textContent = formatSize(data.compressed_size);
  $('reduction-badge').textContent = data.reduction_pct + '% smaller';

  renderPreviews(state.assetType, state.fileId);
  renderRetryButtons(state.assetType, state.preset);

  $('download-btn').onclick = () => { window.location.href = `/api/download/${state.fileId}`; };

  const f0btn = $('frame0-btn');
  if (data.frame0_size != null) {
    f0btn.style.display = '';
    $('frame0-btn-text').innerHTML = `Download Frame 0 (PNG) <span class="frame0-size">${formatSize(data.frame0_size)}</span>`;
    f0btn.onclick = () => { window.location.href = `/api/download/${state.fileId}/frame0`; };
  } else {
    f0btn.style.display = 'none';
  }

  $('results').classList.add('visible');
  $('results').scrollIntoView({ behavior: 'smooth', block: 'start' });
}

$('compress-btn').addEventListener('click', async () => {
  const btn = $('compress-btn');
  btn.disabled = true;
  btn.innerHTML = '<div class="spinner"></div> Compressing...';
  try { await runCompress(); }
  catch (e) { alert(e.message); }
  finally { btn.disabled = false; btn.innerHTML = 'Compress'; }
});

const RETRY_HINTS = {
  light: 'Better quality, larger file',
  balanced: 'Good balance of quality & size',
  aggressive: 'Smallest file, more compression',
};
const RETRY_LABELS = { light: 'Light', balanced: 'Balanced', aggressive: 'Maximum' };

function renderRetryButtons(type, currentPreset) {
  const container = $('retry-buttons');
  const allPresets = ['light', 'balanced', 'aggressive'];

  container.innerHTML = allPresets.map(key => `
    <button class="retry-btn ${key === currentPreset ? 'active' : ''}" data-preset="${key}" ${key === currentPreset ? 'disabled' : ''}>
      <span class="retry-label">${RETRY_LABELS[key]}</span>
      <span class="retry-hint">${key === currentPreset ? 'Current' : RETRY_HINTS[key]}</span>
    </button>
  `).join('');

  container.querySelectorAll('.retry-btn:not(.active)').forEach(btn => {
    btn.addEventListener('click', async () => {
      container.querySelectorAll('.retry-btn').forEach(b => { b.disabled = true; b.style.opacity = '0.5'; });
      btn.innerHTML = '<span class="retry-label">Compressing...</span>';
      try { await runCompress(btn.dataset.preset); }
      catch (e) { alert(e.message); }
      finally {
        container.querySelectorAll('.retry-btn').forEach(b => { b.disabled = false; b.style.opacity = ''; });
      }
    });
  });
}

// ---- Preview modes ----
state.previewMode = 'raw';
state.previewVariant = 'bleed';

document.querySelectorAll('.preview-mode-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.preview-mode-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.previewMode = btn.dataset.mode;
    updateSubToggle();
    if (state.fileId) renderCurrentPreview();
  });
});

document.querySelectorAll('.sub-toggle-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.sub-toggle-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
    state.previewVariant = btn.dataset.variant;
    if (state.fileId) renderCurrentPreview();
  });
});

function updateSubToggle() {
  const mode = state.previewMode;
  const toggle = $('preview-sub-toggle');
  toggle.style.display = (mode === 'fullsheet' || mode === 'halfsheet') ? '' : 'none';
}

function renderCurrentPreview() {
  const mode = state.previewMode;
  const area = $('preview-area');
  const insitu = $('insitu-container');

  if (mode === 'raw') {
    area.style.display = '';
    insitu.style.display = 'none';
    renderRawPreviews(state.assetType, state.fileId);
  } else {
    area.style.display = 'none';
    insitu.style.display = '';
    renderMockup(mode, state.previewVariant, state.assetType, state.fileId);
  }
}

function renderPreviews(type, fileId) {
  renderCurrentPreview();
}

function renderRawPreviews(type, fileId) {
  const area = $('preview-area');
  const ts = Date.now();
  const origUrl = `/api/preview/${fileId}?t=${ts}`;
  const compUrl = `/api/preview/${fileId}/compressed?t=${ts}`;

  if (type === 'video') {
    area.innerHTML = `
      <div class="preview-box"><div class="preview-label">Original</div><video src="${origUrl}" controls loop muted playsinline></video></div>
      <div class="preview-box"><div class="preview-label">Compressed</div><video src="${compUrl}" controls loop muted playsinline></video></div>`;
  } else if (type === 'image') {
    area.innerHTML = `
      <div class="preview-box"><div class="preview-label">Original</div><img src="${origUrl}" /></div>
      <div class="preview-box"><div class="preview-label">Compressed</div><img src="${compUrl}" /></div>`;
  } else if (type === 'lottie') {
    area.innerHTML = `
      <div class="preview-box"><div class="preview-label">Original</div><dotlottie-player src="${origUrl}" autoplay loop style="width:100%;background:#000;"></dotlottie-player></div>
      <div class="preview-box"><div class="preview-label">Compressed</div><dotlottie-player src="${compUrl}" autoplay loop style="width:100%;background:#000;"></dotlottie-player></div>`;
  }
}

function assetEl(type, url) {
  if (type === 'video') return `<video src="${url}" autoplay loop muted playsinline></video>`;
  if (type === 'image') return `<img src="${url}" />`;
  if (type === 'lottie') return `<dotlottie-player src="${url}" autoplay loop style="background:transparent;"></dotlottie-player>`;
  return '';
}

function valuePropRow() {
  return `<div class="mu-prop-row">
    <div class="mu-prop-icon">\u25A6</div>
    <div class="mu-prop-text"><div class="mu-prop-title">Value prop</div><div class="mu-prop-sub">Optional sub-copy</div></div>
  </div>`;
}

function renderMockup(mode, variant, type, fileId) {
  const screen = $('phone-screen');
  const ts = Date.now();
  const compUrl = `/api/preview/${fileId}/compressed?t=${ts}`;
  const asset = assetEl(type, compUrl);

  const statusbar = `<div class="mu-statusbar"><span>9:41</span><div class="mu-status-icons">\u25CF\u25CF\u25CF \u25CF\u25CF\u25CF\u25CF \u2588</div></div>`;
  const homeBar = `<div class="mu-home-bar"></div>`;

  if (mode === 'fullscreen') {
    screen.innerHTML = `
      <div class="mu-fsi mu">
        <div class="mu-bg mu-asset-el">${asset}</div>
        <div class="mu-overlay">
          ${statusbar}
          <div class="mu-close">\u2715</div>
          <div class="mu-content">
            <div class="mu-h1">Large headline with<br/>48 chars max</div>
            <div class="mu-sub">This is an optional sub caption that can run into a couple of lines or more.</div>
          </div>
          <div class="mu-footer"><div class="mu-cta-btn">Let's go!</div></div>
          <div class="mu-legal">OnePay is a financial technology company, not a bank. Banking services provided by Coastal Community Bank or Lead Bank, Members FDIC.</div>
          ${homeBar}
        </div>
      </div>`;
  } else if (mode === 'fullsheet') {
    const isBleed = variant === 'bleed';
    const heroClass = isBleed ? 'mu-hero-bleed' : 'mu-hero-inline';
    const titlebar = isBleed ? '' : `<div class="mu-titlebar"><span class="mu-titlebar-text">Title</span><div class="mu-close">\u2715</div></div>`;
    const closeBtn = isBleed ? `<div class="mu-close" style="position:absolute;top:56px;right:16px;z-index:20;">\u2715</div>` : '';

    screen.innerHTML = `
      <div class="mu-fs mu" style="position:relative;">
        ${statusbar}
        ${titlebar}
        ${closeBtn}
        <div class="${heroClass}">
          <div class="mu-asset-el">${asset}</div>
          <div class="mu-hero-gradient"></div>
        </div>
        <div class="mu-content">
          <div class="mu-h1">Large headline with<br/>48 chars max</div>
          <div class="mu-sub">This is an optional sub caption that can run into a couple of lines or more.</div>
          <div class="mu-props">
            ${valuePropRow()}${valuePropRow()}${valuePropRow()}
          </div>
          <div class="mu-legal">OnePay is a financial technology company, not a bank. Banking services provided by Coastal Community Bank or Lead Bank, Members FDIC.</div>
        </div>
        <div class="mu-footer"><div class="mu-cta-btn">Let's go!</div></div>
        ${homeBar}
      </div>`;
  } else if (mode === 'halfsheet') {
    const isBleed = variant === 'bleed';
    const heroClass = isBleed ? 'mu-hero-bleed' : 'mu-hero-inline';
    const sheetH = isBleed ? '672px' : '672px';

    screen.innerHTML = `
      <div class="mu-hs mu">
        ${statusbar}
        <div class="mu-backdrop"></div>
        <div class="mu-sheet" style="height:${sheetH};">
          <div class="mu-handle"></div>
          <div class="mu-sheet-close">\u2715</div>
          <div class="${heroClass}">
            <div class="mu-asset-el">${asset}</div>
          </div>
          <div class="mu-content">
            <div class="mu-h1">Med headline with<br/>52 characters max</div>
            <div class="mu-sub">This is an optional sub caption that can run into a couple of lines or more.</div>
            <div class="mu-legal">We may not open an account for you, or may reduce any credit limit offered, if you no longer meet our credit criteria or if you do not have sufficient income.</div>
          </div>
          <div class="mu-footer"><div class="mu-cta-btn">Let's go!</div></div>
          ${homeBar}
        </div>
      </div>`;
  } else if (mode === 'banner') {
    screen.innerHTML = `
      <div class="mu-bn mu">
        ${statusbar}
        <div class="mu-screen-body">
          <div class="mu-nav">
            <div class="mu-nav-avi"></div>
            <div style="display:flex;flex-direction:column;gap:2px;">
              <div style="height:10px;width:80px;border-radius:3px;background:rgba(255,255,255,0.15);"></div>
              <div style="height:8px;width:50px;border-radius:3px;background:rgba(255,255,255,0.07);"></div>
            </div>
            <div style="flex:1;"></div>
            <div style="width:28px;height:28px;border-radius:50%;background:rgba(255,255,255,0.08);"></div>
          </div>
          <div class="mu-balance">
            <div class="mu-balance-label">Total balance</div>
            <div class="mu-balance-amount">$4,128.36</div>
          </div>
          <div class="mu-banner-card">
            <div class="mu-banner-bg mu-asset-el">${asset}</div>
            <div class="mu-banner-overlay">
              <div class="mu-banner-title">Abcdefghijklmnopqr<br/>estuvwxyz1234567...</div>
              <div class="mu-banner-sub">Abcdefghijklmnopqrstuvw...</div>
              <div class="mu-banner-link">Abcdefghijklmnopqrstuvw... &rsaquo;</div>
            </div>
          </div>
          <div class="mu-list-items">
            <div class="mu-list-item"><div class="mu-li-icon"></div><div class="mu-li-text"><div class="mu-li-t1"></div><div class="mu-li-t2"></div></div></div>
            <div class="mu-list-item"><div class="mu-li-icon"></div><div class="mu-li-text"><div class="mu-li-t1"></div><div class="mu-li-t2"></div></div></div>
            <div class="mu-list-item"><div class="mu-li-icon"></div><div class="mu-li-text"><div class="mu-li-t1"></div><div class="mu-li-t2"></div></div></div>
          </div>
        </div>
        <div class="mu-tab-bar">
          <div class="mu-tab"><div class="mu-tab-icon"></div><div class="mu-tab-label">Home</div></div>
          <div class="mu-tab"><div class="mu-tab-icon"></div><div class="mu-tab-label">Move</div></div>
          <div class="mu-tab"><div class="mu-tab-icon"></div><div class="mu-tab-label">Wallet</div></div>
          <div class="mu-tab"><div class="mu-tab-icon"></div><div class="mu-tab-label">Invest</div></div>
          <div class="mu-tab"><div class="mu-tab-icon"></div><div class="mu-tab-label">More</div></div>
        </div>
      </div>`;
  }
}

function intVal(id) { const el = document.getElementById(id); return el ? parseInt(el.value, 10) : undefined; }

function formatSize(bytes) {
  if (bytes == null) return '-';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
}
</script>
</body>
</html>
